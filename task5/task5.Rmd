---
title: "Методы статистической обработки информации. Задание 5"
author: "Ершов А. С., гр. 22.М04-мм"
output:
  pdf_document:
    latex_engine: xelatex
    includes:
      in_header: "preamble.tex"
  html_document:
    df_print: paged
  html_notebook: default
---

**Вариант 14.**

- Вариант для проверки однородности двух независимых выборок: метрическая переменная `SBP.1`, категориальная переменная `tremor.1`.

- Вариант для проверки однородности трех независимых выборок: метрическая переменная `SV.1`, первый фактор (категориальная переменная из варианта) - `insomnia.1`, второй фактор - произвольная категориальная переменная).

## Задание

- Задача однородности в случае двух выборок (табл. Варианты для проверки однородности двух независимых выборок). При наличии трех градаций нужно объединить ячейки, чтобы получить две наиболее представленные градации. Проверить на предмет однородности независимых выборок метрическую переменную (столбцы таблицы) в зависимости от категориальной переменной (строки таблицы) по критерию 1) Вилкоксона, 2) Фишера равенства дисперсий, 3) Стьюдента равенства средних. Привести значения средних с ошибками среднего, медиан с интерквартильным размахом, значимости соответствующих критериев.
- Задача однородности в случае более двух выборок (табл. Варианты для проверки однородности трех независимых выборок) Проверить на предмет однородности данные метрической переменной в зависимости от фактора: 1) по критерию Краскела-Уоллиса, 2) при помощи однофакторного дисперсионного анализа. Построить бокс-плот. Применить критерий Стьюдента для множественных сравнений с поправкой Бонферони и критерий Тьюки.
- Выполнить двухфакторный дисперсионный анализ для метрической переменной с двумя факторами (первый из своего варианта, второй произвольный). Сравнить результаты использования моделей с фиксированными и случайными эффектами. 

---

Функции, которые понадобятся для вычислений.

```{r}
suppressWarnings(library('lawstat'))
DescriptiveStat <- function(X, group)
{
  mm <- tapply(X, group, function(x)
    mean(x, na.rm = TRUE))
  mm
  Sd <- tapply(X, group, function(x)
    sd(x, na.rm = TRUE))
  Sd
  nn <- tapply(X, group, function(x)
    length(na.omit(x)))
  nn
  inqr <- tapply(X, group, function(x)
    IQR(x, na.rm = TRUE))
  inqr
  err <- Sd / sqrt(nn)
  err
  list(mm = mm,
       err = err,
       nn = nn,
       inqr = inqr)
}

Sentence <- function(mm, err, nn, inqr)
{
  A1 <-
    paste(paste(
      format(mm, digits = 3, nsmall = 2),
      format(err, digits = 2, nsmall = 2),
      sep = "±"
    ),
    nn, sep = "/")
  A1. <-
    paste("Средние в группах равны соответственно",
          paste(A1, collapse = ", "))
  
  A4. <- paste("интерквартильные размахи равны соответственно", inqr[1], "и", inqr[2])
  paste(c(A1., A4.), sep = "\n")
}
```

Прочитаем тестовые данные из файла:
```{r}
data_big <- read.csv("./data_big.csv")
table(data_big$tremor.1)
```
```{r}
df<-data.frame(group=ifelse(data_big$tremor.1==2,2,1),X= data_big$SBP.1)
```

## Задача однородности в случае двух выборок

Посчитаем значения средних с ошибками среднего, медианы с интерквартильным размахом

```{r}
L<-DescriptiveStat(df$X,df$group)

Sentence(L$mm,L$err,L$nn,L$inqr)
```
```{r}
p.T <- t.test(X ~ group, df, var.equal = TRUE)$p.value
p.T
```
Значение p-value $0.0016$ меньше $0.05$, различия между группами в выборке статистически значимы.

Проверим на предмет однородности независимых выборок метрическую переменную в зависимости от категориальной переменной по критериям Вилкоксона, Фишера равенства дисперий, Стьюдента равенства средних.
```{r}
suppressWarnings(p.W <- wilcox.test(X ~ group, df, exact=TRUE)$p.value)
p.W
p.F <- var.test(X ~ group, df)$p.value
p.F
p.T <- t.test(X ~ group, df, var.equal = TRUE)$p.value
p.T
```

По результатам вычисления всех трех критериев при уровне значимости $0.05$ гипотеза об однородности независимых выборок отвергается.

## Задача однородности в случае более двух выборок

Проверим на предмет однородности данные метрической переменной `SV.1` в зависимости от факторов `insomnia.1` и `tremor.1` по критерию Краскела-Уоллиса.

```{r}
kruskal.test(SV.1 ~ insomia.1, data = data_big)
```
Значение p-value $0.77$ больше $0.05$, что означает, что на уровне значимости $0.05$ гипотеза о том, что различные группы имеют одинаковые распределения, не может быть отвергнута.

Тоже самое при помощи однофакторного дисперсионного анализа.
```{r}
aov <- aov(SV.1 ~ insomia.1, data = data_big)
summary(aov)
```
По результатам значение p-value $0.93$ превышает уровень значимости $0.05$, нулевая гипотеза о том, что между группами нет значимых различий, не может быть отвергнута.

```{r}
boxplot(data_big$SV.1 ~ data_big$insomia.1,
        xlab = "Groups", ylab = "SV.1")
```
На boxplot отображается распределение переменной `SV.1` для каждой группы `insomia.1`. Видно, что медианы значений в группах близки, при этом максимальные и минимальные значения, верхний и нижний квартили отличаются. Также в группе 1 и 2 есть выбросы - значения, выходящие за 1.5 IQR (интерквартильного интервала).

Применим критерий Фишера для множественных сравнений с поправкой Бонферони.
```{r}
df <- data.frame(group = as.factor(data_big$insomia.1), X = as.numeric(data_big$SV.1))
table(df$group)

```

```{r}
suppressMessages(suppressWarnings(library(multcomp)))
suppressMessages(suppressWarnings(library(agricolae)))

aov <- aov(X~group, df)
out <- LSD.test(aov,"group", p.adj="bonferroni",group=FALSE)
out
```
Статистически значимой разницы между группами не обнаружено, p-value > $0.05$.

Применим критерий Тьюки.
```{r}
tukey <- TukeyHSD(aov)
print(tukey)
```
Для всех трех пар групп различия не являются статистически значимыми при уровне значимости $0.05$.

## Двухфакторный дисперсионный анализ

```{r}
df <- data.frame(
  group1 = as.factor(data_big$tremor.1),
  group2 = as.factor(data_big$insomia.1),
  X = as.numeric(data_big$SV.1)
)
ao <- aov(X ~ group1 * group2, df)
SLM <- summary(ao)
SLM
```
Все факторы и их взаимодействие не имеют статистически значимых различий с зависимой переменной, все p-value больше $0.05$.

Посчитаем значимость для модели со случайными эффектами.
```{r}
df_ <- SLM[[1]][,1]
y <- SLM[[1]][,3]

F1 <- y[1] / y[3]
p1 <- 1 - pf(F1, df_[1], df_[3])
F2 <- y[2] / y[3]
p2 <- 1 - pf(F2, df_[2], df_[3])

c(p1, p2)
```
У модели со случайными эффектами эффектами значения p-value получились меньше, чем у модели с фиксированными эффектами, но в обоих случаях они больше $0.05$, значимость не изменилась.